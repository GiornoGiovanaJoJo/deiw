{% extends 'adminka/base.html' %}
{% load static %}

{% block title %}Поддержка - Empire Premium{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'adminka/css/pages/support.css' %}" />
{% endblock %}

{% block content %}
<main class="dashboard">
    <div class="page-actions" data-aos="fade-up">
        <h1>Поддержка</h1>
        <div class="search-box">
            <input type="search" id="requestSearchInput" data-i18n-placeholder="support.search" placeholder="Поиск заявок..." />
            <select id="roleFilter">
                <option data-i18n="support.status.all" value="">Все статусы</option>
                <option data-i18n="support.status.new" value="new">Новые</option>
                <option data-i18n="support.status.in_progress" value="in_progress">В процессе</option>
                <option data-i18n="support.status.closed" value="closed">Закрыта</option>
            </select>        
        </div>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="form-message {% if message.tags %}{{ message.tags }}{% endif %}" style="margin-bottom: 1rem;">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    {% if not requests %}
        <div class="card" style="text-align: center; padding: 3rem;">
            <h3 data-i18n="support.empty.title">Заявки не найдены</h3>
            <p data-i18n="support.empty.description">Пока нет новых заявок</p>
        </div>
    {% else %}
        <div class="card requests-card" data-aos="fade-up" data-aos-delay="500">
            <h2 data-i18n="support.requests.title">Последние заявки</h2>
            <table class="requests-table">
                <thead>
                    <tr>
                        <th data-i18n="support.table.id">ID</th>
                        <th data-i18n="support.table.name">Имя</th>
                        <th data-i18n="support.table.email">Email</th>
                        <th data-i18n="support.table.phone">Телефон</th>
                        <th data-i18n="support.table.status">Статус</th>
                        <th data-i18n="support.table.created_at">Дата создания</th>
                        <th data-i18n="support.table.actions">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                        <tr data-id="{{ req.id }}" 
                            data-status="{{ req.status }}" 
                            data-name="{{ req.name|lower }}" 
                            data-email="{{ req.email }}" 
                            data-phone="{{ req.phone }}" 
                            id="request-row-{{ req.id }}">
                            <td>{{ req.id }}</td>
                            <td>{{ req.name }}</td>
                            <td>{{ req.email }}</td>
                            <td>{{ req.phone }}</td>
                            <td class="status-{{ req.status }}" data-i18n="support.status.{{ req.status }}">{{ req.get_status_display }}</td>
                            <td>{{ req.created_at|date:"d.m.Y H:i" }}</td>
                            <td>
                                <a href="{% url 'main:adminka_support_edit' req.id %}" class="btn-primary actions" style="padding: 0.25rem 0.5rem; font-weight: 500;" title="Редактировать">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </a>
                                <button type="button" class="btn-primary danger actions" onclick="deleteRequest({{ req.id }})" style="padding: 0.25rem 0.5rem; font-weight: 500; cursor: pointer; border: none;" title="Удалить">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
</main>
{% endblock %}

{% block extra_js %}
<script src="{% static 'adminka/js/pages/support.js' %}"></script>
<script>
function getCsrfToken() {
    var m = document.querySelector('meta[name="csrf-token"]');
    return m ? m.getAttribute('content') : '';
}
function deleteRequest(requestId) {
    if (!confirm('Вы уверены, что хотите удалить это обращение?')) return;
    fetch('/adminka/support/' + requestId + '/delete/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCsrfToken(), 'Content-Type': 'application/json' },
    })
    .then(response => response.json())
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            var row = document.getElementById('request-row-' + requestId);
            if (row) row.remove();
        } else {
            alert('Ошибка: ' + (data.message || ''));
        }
    })
    .catch(function() { alert('Ошибка при удалении'); });
}
</script>
{% endblock %}
