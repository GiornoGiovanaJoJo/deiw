{% extends 'adminka/base.html' %}
{% load static %}

{% block title %}Проекты - Empire Premium{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'adminka/css/pages/projects.css' %}" />
{% endblock %}

{% block content %}
<main class="dashboard">
    <div class="page-actions" data-aos="fade-up">
        <h1 data-i18n="projects.title">Проекты</h1>
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="Поиск проектов..." data-i18n-placeholder="projects.search.placeholder">
            <select class="filter-select" id="statusFilter">
                <option value="" data-i18n="projects.filter.all">Все статусы</option>
                <option value="completed" data-i18n="projects.filter.completed">Завершенные</option>
                <option value="in_progress" data-i18n="projects.filter.in_progress">В работе</option>
                <option value="planned" data-i18n="projects.filter.planned">Запланированные</option>
            </select>
            <a href="{% url 'main:adminka_project_add' %}" class="btn-primary">
                <span><i class="fa-solid fa-plus"></i></span>
                <span data-i18n="projects.add">Добавить проект</span>
            </a>
        </div>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="form-message {% if message.tags %}{{ message.tags }}{% endif %}" style="margin-bottom: 1rem;">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <!-- Статистика -->
    <div class="stats-grid" data-aos="fade-up" data-aos-delay="100">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total }}</div>
            <div class="stat-label" data-i18n="projects.stats.total">Всего проектов</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.completed }}</div>
            <div class="stat-label" data-i18n="projects.stats.completed">Завершенные</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.in_progress }}</div>
            <div class="stat-label" data-i18n="projects.stats.in_progress">В работе</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.planned }}</div>
            <div class="stat-label" data-i18n="projects.stats.planned">Запланированные</div>
        </div>
    </div>

    <!-- Сетка проектов -->
    <div class="projects-grid" data-aos="fade-up" data-aos-delay="200">
        {% if not projects %}
            <div class="card" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                <h3 data-i18n="projects.empty.title">Проекты не найдены</h3>
                <p data-i18n="projects.empty.description">Добавьте первый проект, чтобы начать работу</p>
                <a href="{% url 'main:adminka_project_add' %}" class="btn-primary">
                    <span><i class="fa-solid fa-plus"></i></span>
                    <span data-i18n="projects.add">Добавить проект</span>
                </a>
            </div>
        {% else %}
            {% for project in projects %}
            <div class="project-card" 
                 id="project-row-{{ project.project_code }}" 
                 data-status="{{ project.status }}" 
                 data-project-code="{{ project.project_code|lower }}"
                 data-year="{{ project.year|default:'' }}"
                 data-project-name="{{ project.name|lower }}"
                 data-end-date="{{ project.end_date|default:'' }}"
                 data-created-at="{{ project.created_at|date:'Y-m-d' }}"
                 data-category="{{ project.category.name_de|default:''|lower }}"
            >               
                
                <div class="project-header">
                    <div class="project-info">
                        <!-- Название проекта -->
                        <h3>{{ project.name }}</h3>
                        <!-- Код проекта -->
                        <div class="project-code">{{ project.project_code }}</div>
                    </div>
                    <div class="project-status status-{{ project.status }}" data-i18n="projects.status.{{ project.status }}">
                        {{ project.get_status_display }}
                    </div>
                </div>

                <!-- Описание проекта -->
                {% if project.description %}
                    <div class="project-description">
                        {{ project.description|linebreaks }}
                    </div>
                {% endif %}

                <div class="project-meta">
                    <!-- Категория -->
                    {% if project.category %}
                        <div class="meta-item">
                            <div class="meta-label" data-i18n="projects.category">Категория</div>
                            <div class="meta-value">
                                {{ project.category.name_de }}
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if project.year %}
                    <div class="meta-item">
                        <div class="meta-label" data-i18n="projects.year">Год</div>
                        <div class="meta-value">{{ project.year }}</div>
                    </div>
                    {% endif %}
                    
                    {% if project.type %}
                    <div class="meta-item">
                        <div class="meta-label" data-i18n="projects.type">Тип</div>
                        <div class="meta-value">{{ project.type }}</div>
                    </div>
                    {% endif %}
                    
                    {% if project.size %}
                    <div class="meta-item">
                        <div class="meta-label" data-i18n="projects.size">Размер</div>
                        <div class="meta-value">{{ project.size }}</div>
                    </div>
                    {% endif %}
                    
                    {% if project.color %}
                    <div class="meta-item">
                        <div class="meta-label" data-i18n="projects.color">Цвет</div>
                        <div class="meta-value">
                            <span style="display: inline-block; width: 20px; height: 20px; background-color: {{ project.color }}; border-radius: 50%; margin-right: 0.5rem; vertical-align: middle;"></span>
                            {{ project.color }}
                        </div>
                    </div>
                    {% endif %}

                    {% if project.end_date %}
                    <div class="meta-item">
                        <div class="meta-label" data-i18n="projects.end_date">Дата окончания</div>
                        <div class="meta-value">{{ project.end_date|date:"d.m.Y" }}</div>
                    </div>
                    {% endif %}
                    
                    <div class="meta-item">
                        <div class="meta-label" data-i18n="projects.created">Создан</div>
                        <div class="meta-value">{{ project.created_at|date:"d.m.Y" }}</div>
                    </div>
                </div>                

                <div class="project-actions">
                    <a href="{% url 'main:adminka_project_view' project.pk %}" class="btn-action">
                        <span><i class="fa-solid fa-clipboard"></i></span>
                        <span data-i18n="projects.actions.view">Просмотр</span>
                    </a>                           
                    <a href="{% url 'main:adminka_project_edit' project.pk %}" class="btn-action">
                        <span><i class="fa-solid fa-pen-to-square"></i></span>
                        <span data-i18n="projects.actions.edit">Редактировать</span>
                    </a>
                    <button class="btn-action danger" onclick="deleteProjectAjax('{{ project.pk }}')">
                        <span><i class="fa-solid fa-trash"></i></span>
                        <span data-i18n="projects.actions.delete">Удалить</span>
                    </button>
                </div>
            </div>
            {% endfor %}
        {% endif %}
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script src="{% static 'adminka/js/pages/projects.js' %}"></script>
<script>
// Функция удаления проекта через AJAX
function deleteProjectAjax(projectId) {
    if (!confirm('Вы уверены, что хотите удалить этот проект?')) {
        return;
    }
    
    fetch(`/adminka/projects/${projectId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при удалении проекта');
    });
}
</script>
{% endblock %}
