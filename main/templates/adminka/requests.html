{% extends 'adminka/base.html' %}
{% load static %}

{% block title %}Заявки - Empire Premium{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'adminka/css/pages/support.css' %}" />
{% endblock %}

{% block content %}
<main class="dashboard">
    <div class="page-actions" data-aos="fade-up">
        <h1>Заявки</h1>
        <div class="search-box">
            <input type="search" id="requestSearchInput" placeholder="Поиск по имени, email, телефону..." />
            <select id="roleFilter">
                <option value="">Все статусы</option>
                <option value="new">Новая</option>
                <option value="in_progress">В процессе</option>
                <option value="closed">Закрыта</option>
            </select>
        </div>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="form-message {% if message.tags %}{{ message.tags }}{% endif %}" style="margin-bottom: 1rem;">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    {% if not requests %}
        <div class="card" style="text-align: center; padding: 3rem;">
            <h3>Заявки не найдены</h3>
            <p>Пока нет заявок с сайта</p>
        </div>
    {% else %}
        <div class="card requests-card" data-aos="fade-up" data-aos-delay="500">
            <h2>Заявки с сайта</h2>
            <table class="requests-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Имя</th>
                        <th>Email</th>
                        <th>Телефон</th>
                        <th>Категория</th>
                        <th>Подкатегория</th>
                        <th>Статус</th>
                        <th>Дата</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                        <tr data-id="{{ req.id }}" data-status="{{ req.status }}" data-name="{{ req.name|lower }}" data-email="{{ req.email }}" data-phone="{{ req.phone }}" id="request-row-{{ req.id }}">
                            <td>{{ req.id }}</td>
                            <td>{{ req.name }}</td>
                            <td>{{ req.email }}</td>
                            <td>{{ req.phone }}</td>
                            <td>{{ req.category|default:"—" }}</td>
                            <td>{{ req.subcategory|default:"—" }}</td>
                            <td class="status-{{ req.status }}">{{ req.get_status_display }}</td>
                            <td>{{ req.created_at|date:"d.m.Y H:i" }}</td>
                            <td>
                                <a href="{% url 'main:adminka_request_edit' req.id %}" class="btn-primary actions" style="padding: 0.25rem 0.5rem; font-weight: 500;" title="Редактировать">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </a>
                                <button type="button" class="btn-primary danger actions" onclick="deleteRequest({{ req.id }})" style="padding: 0.25rem 0.5rem; font-weight: 500; cursor: pointer; border: none;" title="Удалить">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
</main>
{% endblock %}

{% block extra_js %}
<script src="{% static 'adminka/js/pages/support.js' %}"></script>
<script>
function getCsrfToken() {
    var m = document.querySelector('meta[name="csrf-token"]');
    return m ? m.getAttribute('content') : '';
}
function deleteRequest(requestId) {
    if (!confirm('Удалить эту заявку?')) return;
    fetch('/adminka/requests/' + requestId + '/delete/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCsrfToken(), 'Content-Type': 'application/json' },
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            document.getElementById('request-row-' + requestId).remove();
        } else { alert('Ошибка: ' + (data.message || '')); }
    })
    .catch(function(e) { alert('Ошибка при удалении'); });
}
</script>
{% endblock %}
