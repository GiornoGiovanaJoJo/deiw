{% extends 'cabinet/base.html' %}
{% load static %}

{% block title %}Управление профилем - Empire Premium{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'adminka/css/pages/profile.css' %}" />
{% endblock %}

{% block content %}
<div class="profile-page">
<div class="page-actions" data-aos="fade-up">
    <h1>Управление профилем</h1>
    <button type="button" class="btn-primary" id="btnEditProfileModal" title="Редактировать имя, телефон и почту">
        <i class="fa-solid fa-pen"></i> Редактировать данные
    </button>
</div>

<div class="card" data-aos="fade-up">
    <div class="cabinet-profile-layout">
        <div class="cabinet-profile-avatar-block">
            <form method="post" action="{% url 'main:cabinet_profile' %}" enctype="multipart/form-data" class="cabinet-avatar-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="avatar">
                <label class="cabinet-avatar-label">
                    {% if profile.avatar %}
                    <div class="cabinet-avatar cabinet-avatar-large cabinet-avatar-img" style="background-image: url('{{ profile.avatar.url }}');"></div>
                    {% else %}
                    <div class="cabinet-avatar cabinet-avatar-large">
                        <span>{% with name=profile_user.get_full_name|default:profile_user.username %}{{ name|slice:":1"|upper }}{% endwith %}</span>
                    </div>
                    {% endif %}
                    <input type="file" name="avatar" accept="image/jpeg,image/png,image/gif,image/webp" class="cabinet-avatar-input">
                    <span class="cabinet-change-photo">Изменить фото</span>
                </label>
            </form>
            <p class="cabinet-change-photo-hint">JPG, PNG до 5 МБ</p>
        </div>
        <div class="cabinet-profile-fields">
            <p class="cabinet-profile-id">ID {{ profile_user.pk|stringformat:"011d" }}</p>
            <p style="color: var(--color-text-secondary); margin-top: 0.5rem;">Имя: {% firstof profile_user.get_full_name "—" %}</p>
            <p style="color: var(--color-text-secondary);">Телефон: {{ profile.phone|default:"—" }}</p>
            <p style="color: var(--color-text-secondary);">Почта: {{ profile_user.email|default:"—" }}</p>
        </div>
    </div>
</div>

<!-- Модальное окно: Редактирование профиля -->
<div class="cabinet-modal" id="modalEditProfile" role="dialog" aria-labelledby="modalEditProfileTitle" aria-modal="true" hidden>
    <div class="cabinet-modal-backdrop"></div>
    <div class="cabinet-modal-content cabinet-modal-animate">
        <div class="cabinet-modal-header">
            <h2 id="modalEditProfileTitle">Редактировать данные</h2>
            <button type="button" class="cabinet-modal-close" aria-label="Закрыть">&times;</button>
        </div>
        <form method="post" action="{% url 'main:cabinet_profile' %}" class="cabinet-modal-form" id="formEditProfile">
            {% csrf_token %}
            <input type="hidden" name="action" value="profile">
            <div class="form-group">
                <label for="modal_first_name">Имя</label>
                <input type="text" id="modal_first_name" name="first_name" value="{% if profile_form.first_name.value %}{{ profile_form.first_name.value }}{% else %}{{ profile_user.first_name|default:'' }}{% endif %}" placeholder="Имя">
                <input type="text" name="last_name" value="{% if profile_form.last_name.value != None %}{{ profile_form.last_name.value }}{% else %}{{ profile_user.last_name|default:'' }}{% endif %}" placeholder="Фамилия">
                {% if profile_form.first_name.errors or profile_form.last_name.errors %}<span class="auth-field-error">{% for e in profile_form.first_name.errors %}{{ e }}{% endfor %}{% for e in profile_form.last_name.errors %}{{ e }}{% endfor %}</span>{% endif %}
            </div>
            <div class="form-group">
                <label for="modal_phone">Номер телефона</label>
                <input type="tel" id="modal_phone" name="phone" value="{% if profile_form.phone.value != None %}{{ profile_form.phone.value }}{% else %}{{ profile.phone|default:'' }}{% endif %}" placeholder="+49 (900) 000 000 000">
                {% if profile_form.phone.errors %}<span class="auth-field-error">{% for e in profile_form.phone.errors %}{{ e }}{% endfor %}</span>{% endif %}
            </div>
            <div class="form-group">
                <label for="modal_email">Почта *</label>
                <input type="email" id="modal_email" name="email" value="{% if profile_form.email.value != None %}{{ profile_form.email.value }}{% else %}{{ profile_user.email|default:'' }}{% endif %}" placeholder="Почта" required>
                {% if profile_form.email.errors %}<span class="auth-field-error">{% for e in profile_form.email.errors %}{{ e }}{% endfor %}</span>{% endif %}
            </div>
            <div class="cabinet-modal-footer">
                <button type="button" class="btn-secondary cabinet-modal-close-btn">Отмена</button>
                <button type="submit" class="btn-primary">Готово</button>
            </div>
        </form>
    </div>
</div>

<div class="card" data-aos="fade-up">
    <h3>Двухфакторная аутентификация (2FA)</h3>
    <p style="color: var(--color-text-secondary); margin-bottom: 0.75rem;">Подтверждение входа по SMS или Telegram повышает безопасность аккаунта.</p>
    <p class="cabinet-2fa-placeholder"><i class="fa-solid fa-lock" title="В разработке"></i> Функция в разработке. Скоро будет доступна настройка 2FA через SMS и Telegram.</p>
</div>

<div class="card" data-aos="fade-up">
    <h3>Сменить пароль</h3>
    <form method="post" class="profile-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="password">
        <div class="form-group">
            <label for="old_password">Текущий пароль</label>
            <input type="password" id="old_password" name="old_password" autocomplete="current-password" placeholder="Введите текущий пароль">
        </div>
        <div class="form-group">
            <label for="new_password1">Новый пароль</label>
            <input type="password" id="new_password1" name="new_password1" autocomplete="new-password" placeholder="Не менее 8 символов">
        </div>
        <div class="form-group">
            <label for="new_password2">Повторите новый пароль</label>
            <input type="password" id="new_password2" name="new_password2" autocomplete="new-password" placeholder="Повторите пароль">
        </div>
        <button type="submit" class="btn-primary">Изменить пароль</button>
    </form>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    var form = document.querySelector('.cabinet-avatar-form');
    var input = form && form.querySelector('input[name="avatar"]');
    if (input) input.addEventListener('change', function() { if (this.files.length) form.submit(); });

    var modal = document.getElementById('modalEditProfile');
    var btnOpen = document.getElementById('btnEditProfileModal');
    function openProfileModal() {
        if (modal) { modal.removeAttribute('hidden'); document.body.style.overflow = 'hidden'; }
    }
    function closeProfileModal() {
        if (modal) { modal.setAttribute('hidden', ''); document.body.style.overflow = ''; }
    }
    if (btnOpen) btnOpen.addEventListener('click', openProfileModal);
    if (modal) modal.querySelectorAll('.cabinet-modal-close, .cabinet-modal-close-btn, .cabinet-modal-backdrop').forEach(function(el) {
        el.addEventListener('click', closeProfileModal);
    });
})();
</script>
{% endblock %}
