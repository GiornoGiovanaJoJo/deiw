{% extends 'cabinet/base.html' %}
{% load static %}

{% block title %}Управление профилем - Empire Premium{% endblock %}

<div class="page-title">Управление профилем</div>

<div class="cards-list">
    <!-- Profile Info Card -->
    <div class="item-card" style="align-items: flex-start;">
        <div style="flex: 0 0 auto; margin-right: 2rem; position: relative;">
            <form method="post" action="{% url 'main:cabinet_profile' %}" enctype="multipart/form-data" id="avatarForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="avatar">

                <div class="user-avatar-large"
                    style="width: 120px; height: 120px; font-size: 3rem; position: relative; overflow: hidden; cursor: pointer;"
                    onclick="document.getElementById('avatarInput').click()">
                    {% if user_profile.avatar_data %}
                    <img src="{% url 'main:serve_db_image' 'userprofile' user_profile.pk %}" alt="Avatar"
                        style="width:100%; height:100%; object-fit:cover;">
                    {% else %}
                    <i class="fa-regular fa-user"></i>
                    {% endif %}

                    <div
                        style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; font-size: 0.8rem; text-align: center; padding: 0.25rem;">
                        <i class="fa-solid fa-camera"></i>
                    </div>
                </div>
                <input type="file" name="avatar" id="avatarInput" style="display: none;" accept="image/*"
                    onchange="document.getElementById('avatarForm').submit()">
            </form>
        </div>

        <div style="flex: 1;">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">{% firstof
                profile_user.get_full_name profile_user.username %}</h2>
            <div style="color: var(--text-secondary); margin-bottom: 1.5rem;">ID {{ profile_user.pk|stringformat:"010d"
                }}</div>

            <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 2rem; align-items: center;">
                <div style="color: var(--text-secondary);">Телефон:</div>
                <div>{{ user_profile.phone|default:"—" }}</div>

                <div style="color: var(--text-secondary);">Email:</div>
                <div>{{ profile_user.email|default:"—" }}</div>
            </div>

            <button class="btn-primary-purple" style="margin-top: 1.5rem;" onclick="openProfileModal()">
                <i class="fa-solid fa-pen"></i> Редактировать данные
            </button>
        </div>
    </div>

    <!-- Password Change Card -->
    <div class="item-card" style="display: block;">
        <h3 style="margin-bottom: 1.5rem; font-weight: 700; font-size: 1.25rem;">Сменить пароль</h3>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="password">

            <div style="margin-bottom: 1rem;">
                <input type="password" name="old_password" class="search-input" placeholder="Текущий пароль"
                    style="width: 100%; background: #F9FAFB;">
            </div>
            <div style="margin-bottom: 1rem;">
                <input type="password" name="new_password1" class="search-input" placeholder="Новый пароль"
                    style="width: 100%; background: #F9FAFB;">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <input type="password" name="new_password2" class="search-input" placeholder="Повторите новый пароль"
                    style="width: 100%; background: #F9FAFB;">
            </div>

            <button type="submit" class="btn-secondary">Изменить пароль</button>
        </form>
    </div>

    <!-- 2FA Placeholder -->
    <div class="item-card" style="display: block; opacity: 0.7;">
        <h3
            style="margin-bottom: 1rem; font-weight: 700; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fa-solid fa-shield-halved"></i> Двухфакторная аутентификация
        </h3>
        <p>Функция в разработке. Скоро будет доступна настройка 2FA через SMS и Telegram.</p>
    </div>
</div>

<!-- Modal: Edit Profile -->
<div class="cabinet-modal" id="modalEditProfile" hidden>
    <div class="cabinet-modal-backdrop" onclick="closeProfileModal()"></div>
    <div class="cabinet-modal-content">
        <div class="cabinet-modal-header">
            <h2>Редактировать данные</h2>
            <button type="button" class="cabinet-modal-close" onclick="closeProfileModal()">&times;</button>
        </div>
        <form method="post" class="cabinet-modal-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="profile">

            <label>Имя</label>
            <input type="text" name="first_name" value="{{ profile_user.first_name|default:'' }}" class="search-input"
                style="width: 100%; margin-bottom: 1rem; background: #F9FAFB;">

            <label>Фамилия</label>
            <input type="text" name="last_name" value="{{ profile_user.last_name|default:'' }}" class="search-input"
                style="width: 100%; margin-bottom: 1rem; background: #F9FAFB;">

            <label>Телефон</label>
            <input type="tel" name="phone" value="{{ user_profile.phone|default:'' }}" class="search-input"
                style="width: 100%; margin-bottom: 1rem; background: #F9FAFB;">

            <label>Email</label>
            <input type="email" name="email" value="{{ profile_user.email|default:'' }}" class="search-input"
                style="width: 100%; margin-bottom: 1.5rem; background: #F9FAFB;" required>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" class="btn-secondary" onclick="closeProfileModal()">Отмена</button>
                <button type="submit" class="btn-primary-purple">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openProfileModal() {
        document.getElementById('modalEditProfile').removeAttribute('hidden');
    }
    function closeProfileModal() {
        document.getElementById('modalEditProfile').setAttribute('hidden', '');
    }
</script>