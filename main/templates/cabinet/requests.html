{% extends 'cabinet/base.html' %}
{% load static %}

{% block title %}Заявки - Empire Premium{% endblock %}

{% block content %}
<div class="page-title">Заявки</div>

<form method="get" class="filters-bar" id="cabinetFiltersForm">
    <select name="status" class="filter-select" onchange="this.form.submit()">
        <option value="">Статус заказа</option>
        <option value="new" {% if filter_status=='new' %}selected{% endif %}>Новая</option>
        <option value="in_progress" {% if filter_status=='in_progress' %}selected{% endif %}>В обработке</option>
        <option value="approved" {% if filter_status=='approved' %}selected{% endif %}>Одобрена</option>
        <option value="rejected" {% if filter_status=='rejected' %}selected{% endif %}>Отклонена</option>
        <option value="closed" {% if filter_status=='closed' %}selected{% endif %}>Закрыта</option>
    </select>

    <select name="category" class="filter-select" onchange="this.form.submit()">
        <option value="">Категория услуги</option>
        {% for cat in all_categories %}
        <option value="{{ cat.pk }}" {% if filter_category==cat.pk %}selected{% endif %}>{{
            cat.name_de|default:cat.name|default:"—" }}</option>
        {% endfor %}
    </select>

    <input type="text" name="search" class="search-input" value="{{ filter_search|default:'' }}"
        placeholder="Поиск по номеру заказа" />
</form>

{% if not user_requests %}
<div class="item-card" style="justify-content: center; padding: 3rem;">
    <div style="text-align: center;">
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Заявок пока нет</p>
        <button class="btn-primary-purple" onclick="alert('Функционал создания заявки')">Оставить заявку</button>
    </div>
</div>
{% else %}
<div class="cards-list">
    {% for req in user_requests %}
    <div class="item-card">
        <div class="card-status">
            <span style="font-weight: 700;">
                {% if req.status == 'new' %}В обработке
                {% elif req.status == 'in_progress' %}В работе
                {% elif req.status == 'approved' %}Принята
                {% elif req.status == 'rejected' %}Отклонена
                {% elif req.status == 'closed' %}Завершена
                {% else %}{{ req.get_status_display }}{% endif %}
            </span>
        </div>

        <div class="card-info">
            <div class="card-title">{{ req.message|truncatewords:5|default:"Без названия" }}</div>
            <div class="card-meta">
                <div>Категория: {{ req.category.name|default:"Общая" }}</div>
                <div>Номер заявки: {{ req.display_number|default:req.pk }}</div>
            </div>
        </div>

        <a href="{% url 'main:cabinet_request_detail' req.pk %}" class="card-action"
            style="background: #E5E7EB; display: block;">
            <!-- Gray box placeholder from design -->
        </a>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Модальное окно: Создать заявку -->
<div class="cabinet-modal" id="modalCreateRequest" role="dialog" aria-labelledby="modalCreateRequestTitle"
    aria-modal="true" hidden>
    <div class="cabinet-modal-backdrop"></div>
    <div class="cabinet-modal-content cabinet-modal-animate">
        <div class="cabinet-modal-header">
            <h2 id="modalCreateRequestTitle">Создать заявку</h2>
            <button type="button" class="cabinet-modal-close" aria-label="Закрыть">&times;</button>
        </div>
        <form id="formCreateRequest" class="cabinet-modal-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="modalCategory">Категория</label>
                <select id="modalCategory" name="category_id" required>
                    <option value="">— Выберите —</option>
                </select>
            </div>
            <div class="form-group">
                <label for="modalSubcategory">Подкатегория</label>
                <select id="modalSubcategory" name="subcategory_id">
                    <option value="">— Выберите —</option>
                </select>
            </div>
            <div id="modalQuestions"></div>
            <div class="form-group">
                <label for="modalName">Имя *</label>
                <input type="text" id="modalName" name="name" required
                    value="{{ user.get_full_name|default:user.email }}" />
            </div>
            <div class="form-group">
                <label for="modalPhone">Телефон *</label>
                <input type="tel" id="modalPhone" name="phone" required />
            </div>
            <div class="form-group">
                <label for="modalEmail">Email *</label>
                <input type="email" id="modalEmail" name="email" required value="{{ user.email }}" />
            </div>
            <div class="form-group">
                <label for="modalMessage">Сообщение</label>
                <textarea id="modalMessage" name="message" rows="3"></textarea>
            </div>
            <div class="cabinet-modal-footer">
                <button type="button" class="btn-secondary cabinet-modal-close-btn">Отмена</button>
                <button type="submit" class="btn-primary">Отправить заявку</button>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script src="{% static 'adminka/js/pages/cabinet-filters.js' %}"></script>
<script src="{% static 'adminka/js/pages/cabinet-requests.js' %}"></script>
{% endblock %}
{% endblock %}