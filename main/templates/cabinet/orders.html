{% extends 'cabinet/base.html' %}
{% load static %}

{% block title %}Заказы - Empire Premium{% endblock %}

{% block content %}
<div class="page-title">Заказы</div>

<form class="filters-bar" id="cabinetFiltersForm">
    <select id="statusFilter" class="filter-select">
        <option value="">Статус заказа</option>
        <option value="closed">Завершен</option>
        <option value="in_progress">Активен</option>
    </select>
    <select id="categoryFilter" class="filter-select">
        <option value="">Категория услуги</option>
        {% for cat in categories %}
        <option value="{{ cat.name_de|default:cat.name|default:'' }}">{{ cat.name_de|default:cat.name|default:"—" }}
        </option>
        {% endfor %}
    </select>
    <input type="text" id="searchInput" class="search-input" placeholder="Поиск по номеру заказа..." />
</form>

{% if not user_requests %}
<div class="item-card" style="justify-content: center; padding: 3rem;">
    <div style="text-align: center;">
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Заказов пока нет</p>
        <a href="{% url 'main:home' %}#contact" class="btn-primary-purple"
            style="display:inline-block; text-decoration:none;">Оставить заявку</a>
    </div>
</div>
{% else %}

<!-- Завершенные -->
{% for req in user_requests %}
{% if req.status == 'closed' %}
{% if forloop.first or prev_status != 'closed' %}
<h2 style="font-size: 1.5rem; font-weight: 700; margin: 2rem 0 1rem;">Завершен</h2>
<div class="cards-list">
    {% endif %}

    <div class="item-card" data-status="closed">
        <div class="card-status">
            <span style="font-weight: 700;">Завершен</span>
        </div>
        <div class="card-info">
            <div class="card-title">{{ req.message|truncatewords:5|default:"Название заказа" }}</div>
            <div class="card-meta">
                <div>Категория заказа: {{ req.category|default:"—" }}</div>
                <div>Номер заказа: {{ req.display_number }}</div>
            </div>
        </div>
        <a href="{% url 'main:cabinet_order_detail' req.pk %}" class="card-action"
            style="background: #E5E7EB; display: block;"></a>
    </div>

    {% if forloop.last or next_status != 'closed' %}
    <!-- Logic simplified as we can't easily peek next in Django templates without custom tags, so might need just grouping in view ideally. But sticking to template logic: -->
</div>
{% endif %}
{% endif %}
{% endfor %}

<!-- Активные (В работе, Новые, Одобренные) -->
<h2 style="font-size: 1.5rem; font-weight: 700; margin: 2rem 0 1rem;">Активен</h2>
<div class="cards-list">
    {% for req in user_requests %}
    {% if req.status == 'in_progress' or req.status == 'new' or req.status == 'approved' %}
    <div class="item-card" data-status="active">
        <div class="card-status">
            <span style="font-weight: 700;">Активен</span>
        </div>
        <div class="card-info">
            <div class="card-title">{{ req.message|truncatewords:5|default:"Название заказа" }}</div>
            <div class="card-meta">
                <div>Категория заказа: {{ req.category|default:"—" }}</div>
                <div>Номер заказа: {{ req.display_number }}</div>
            </div>
        </div>
        <a href="{% url 'main:cabinet_order_detail' req.pk %}" class="card-action"
            style="background: #E5E7EB; display: block;"></a>
    </div>
    {% endif %}
    {% endfor %}
</div>

{% endif %}

{% block extra_js %}
<script src="{% static 'adminka/js/pages/cabinet-filters.js' %}"></script>
{% endblock %}
{% endblock %}