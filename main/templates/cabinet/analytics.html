{% extends 'cabinet/base.html' %}
{% load static %}

{% block title %}История и аналитика - Empire Premium{% endblock %}

{% block extra_css %}
<style>
.cabinet-analytics-section { margin-bottom: 2rem; }
.cabinet-analytics-section h2 { font-size: 1.25rem; margin-bottom: 1rem; color: var(--color-text-primary); }
.cabinet-table-wrap { overflow-x: auto; margin-bottom: 1rem; }
.cabinet-analytics-table { width: 100%; border-collapse: collapse; background: var(--color-surface); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px var(--color-shadow); }
.cabinet-analytics-table th, .cabinet-analytics-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--color-border); }
.cabinet-analytics-table th { background: rgba(108, 99, 255, 0.1); color: var(--color-primary); font-weight: 600; }
.cabinet-analytics-table tr:hover { background: rgba(108, 99, 255, 0.04); }
.cabinet-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
@media (max-width: 768px) { .cabinet-charts { grid-template-columns: 1fr; } }
.cabinet-chart-card { background: var(--color-surface); border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px var(--color-shadow); }
.cabinet-chart-card h3 { font-size: 1rem; margin-bottom: 1rem; color: var(--color-text-primary); }
.cabinet-export-buttons { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.5rem; }
.cabinet-empty-state { text-align: center; padding: 3rem; color: var(--color-text-muted); background: var(--color-surface-alt); border-radius: 12px; }
.cabinet-empty-state p { margin: 0.5rem 0; }
</style>
{% endblock %}

{% block content %}
<div class="page-actions" data-aos="fade-up">
    <h1>История и аналитика</h1>
    <div class="cabinet-export-buttons">
        <a href="{% url 'main:cabinet_export_pdf' %}" class="btn-primary" title="Скачать PDF"><i class="fa-solid fa-file-pdf"></i> Экспорт в PDF</a>
        <a href="{% url 'main:cabinet_export_excel' %}" class="btn-secondary" title="Скачать Excel"><i class="fa-solid fa-file-excel"></i> Экспорт в Excel</a>
    </div>
</div>

<div class="cabinet-analytics-section" data-aos="fade-up">
    <h2>История заявок</h2>
    {% if history %}
    <div class="cabinet-table-wrap">
        <table class="cabinet-analytics-table">
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Номер</th>
                    <th>Статус</th>
                    <th>Сумма</th>
                </tr>
            </thead>
            <tbody>
                {% for h in history %}
                <tr>
                    <td>{{ h.created_at }}</td>
                    <td><a href="{% url 'main:cabinet_request_detail' h.id %}">{{ h.display_number }}</a></td>
                    <td>{{ h.status_display }}</td>
                    <td>{% if h.amount is not None %}{{ h.amount }}{% else %}—{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="cabinet-empty-state">
        <p><i class="fa-solid fa-chart-line" style="font-size: 2rem; opacity: 0.5;"></i></p>
        <p>Пока нет заявок. История появится после создания заявок.</p>
    </div>
    {% endif %}
</div>

<div class="cabinet-charts">
    <div class="cabinet-chart-card" data-aos="fade-up">
        <h3>Одобрения по месяцам</h3>
        <canvas id="chartLine" width="400" height="200"></canvas>
    </div>
    <div class="cabinet-chart-card" data-aos="fade-up">
        <h3>Заявки по статусам</h3>
        <canvas id="chartPie" width="400" height="200"></canvas>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function() {
    var byMonth = {{ by_month_json|safe }};
    var byStatus = {{ by_status_json|safe }};
    if (!Array.isArray(byMonth)) byMonth = [];
    if (!Array.isArray(byStatus)) byStatus = [];

    if (document.getElementById('chartLine')) {
        new Chart(document.getElementById('chartLine'), {
            type: 'line',
            data: {
                labels: (byMonth && byMonth.length) ? byMonth.map(function(m) { return m.label; }) : ['Нет данных'],
                datasets: [{
                    label: 'Одобрено',
                    data: (byMonth && byMonth.length) ? byMonth.map(function(m) { return m.count; }) : [0],
                    borderColor: '#6c63ff',
                    backgroundColor: 'rgba(108, 99, 255, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });
    }
    if (document.getElementById('chartPie')) {
        var statusLabels = { new: 'Новая', in_progress: 'В обработке', approved: 'Одобрена', rejected: 'Отклонена', closed: 'Закрыта' };
        new Chart(document.getElementById('chartPie'), {
            type: 'pie',
            data: {
                labels: (byStatus && byStatus.length) ? byStatus.map(function(s) { return statusLabels[s.status] || s.status; }) : ['Нет данных'],
                datasets: [{
                    data: (byStatus && byStatus.length) ? byStatus.map(function(s) { return s.count; }) : [1],
                    backgroundColor: ['#6c63ff', '#5147e9', '#28a745', '#dc3545', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }
})();
</script>
{% endblock %}
